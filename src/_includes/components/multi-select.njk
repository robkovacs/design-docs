{% from './chip.njk' import render as chip %}
{% from './input-label.njk' import render as inputLabel %}
{% from './input-message.njk' import render as inputMessage %}
{% from './system-icon.njk' import render as systemIcon %}

{% set localeData = {
    "en_US": {
        placeholder: "Select&hellip;",
        listboxEmpty: "No matching options"
    },
    "de_DE": {
        placeholder: "WÃ¤hlen&hellip;",
        listboxEmpty: "Keine passenden Optionen"
    }
} %}

{% macro render(options) %}
    {% set required = (options.required | default(true)) %}
    {% set id = (options.id | default(nanoid())) %}
    {% set typeaheadId = nanoid() %}
    {% set locale = options.locale | default("en_US") %}
    {% set placeholder = options.placeholder | default(localeData[locale].placeholder) %}
    
    {% set classes -%}
    {#- TODO: make this into a custom filter -#}
        {%- if options.classes -%}
            {%- if options.classes == (options.classes | string) -%}
                {{ options.classes }}
            {%- else -%}
                {{ options.classes | join(' ') }}
            {%- endif -%}
        {%- endif -%}
    {%- endset %}

    {% if options.label or options.messages %}
        <div class="form-field">
    {% endif %}
            {{ inputLabel(options.label, required, typeaheadId, locale = locale) if options.label }}
            {{ inputMessage("help", options.helpText) if options.helpText }}
            <div class="multi-select__wrapper">
                <input type="hidden"
                    class="multi__select--input {{ classes }}"
                    id="{{ id | safe }}"
                    {{ ('aria-disabled="true"' | safe) if options.disabled }}
                    {{ 'required' if required }}
                    {% for key, value in options.attributes %}
                        {% if key !== "id" %}
                            {{ key }}="{{ value | safe }}"
                        {% endif %}
                    {% endfor %}
                />
                <div class="multi-select__container">
                    <input
                        type="text"
                        id="{{ typeaheadId | safe }}"
                        class="multi-select__typeahead"
                        placeholder="{{ placeholder | safe }}"
                    />
                    {{ systemIcon('chevron-down', classes = 'multi-select__icon') }}
                </div>
            {% if options.options %}
                <div class="multi-select__listbox" tabindex="1">
                    {% for item in options.options %}
                        {% if item.options %}
                            <div class="multi-select__optgroup" {{ ('aria-disabled="true"' | safe) if item.disabled }}>
                                <div class="multi-select__optgroup-label">{{ item.label }}</div>
                                {% for option in item.options %}
                                    {% set value = option.value | default(option.label) %}
                                    <button
                                        class="multi-select__option"
                                        id="{{ nanoid() }}"
                                        {{ ('aria-disabled="true"' | safe) if option.disabled }}
                                        data-value="{{ value | safe }}"
                                    >
                                        {{ option.label }}
                                    </button>
                                {% endfor %}
                            </div>
                        {% else %}
                            {% set value = item.value | default(item.label) %}
                            <button
                                class="multi-select__option"
                                id="{{ nanoid() }}"
                                {{ ('aria-disabled="true"' | safe) if item.disabled }}
                                data-value="{{ value | safe }}"
                            >
                                {{ item.label }}
                            </button>
                        {% endif %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="multi-select__listbox multi-select__listbox--empty" tabindex="1">
                    <span>{{ localeData[locale].listboxEmpty }}</span>
                </div>
            {% endif %}
        </div>
    {% if options.messages %}
        <div class="input-message__list">
           {% for message in options.messages %}
                {{ inputMessage(message.type, message.message) }}
           {% endfor %} 
        </div>
    {% endif %}
    {% if options.label or options.messages %}
        </div>
    {% endif %}
{% endmacro %}